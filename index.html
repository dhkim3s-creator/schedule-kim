import React, { useState, useEffect } from 'react';
import { Trash2, Plus, Calendar, Clock, CheckCircle2, Circle, ChevronLeft, ChevronRight, AlertCircle, WifiOff, RefreshCw } from 'lucide-react';
import { initializeApp } from "firebase/app";
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken,
  Auth
} from "firebase/auth";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  doc, 
  onSnapshot,
  serverTimestamp,
  query,
  Firestore
} from "firebase/firestore";

// --- Firebase Configuration & Initialization ---
const firebaseConfig = {
  apiKey: "AIzaSyBSwGAhynYlK68A18WEqWSG1XZaY_q3VHw",
  authDomain: "schedule-kim.firebaseapp.com",
  databaseURL: "https://schedule-kim-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "schedule-kim",
  storageBucket: "schedule-kim.firebasestorage.app",
  messagingSenderId: "623069272138",
  appId: "1:623069272138:web:5caa87bf0723083149aeb3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = (window as any).__app_id || 'schedule-kim-app';

// --- Types ---
interface Task {
  id: string;
  text: string;
  date: string; // YYYY-MM-DD
  time: string; // HH:mm (24h format for sorting)
  completed: boolean;
  createdAt: any;
}

export default function App() {
  const [user, setUser] = useState<any>(null);
  const [tasks, setTasks] = useState<Task[]>([]);
  const [authError, setAuthError] = useState<string | null>(null);
  const [isOfflineMode, setIsOfflineMode] = useState(false);
  const [isRetrying, setIsRetrying] = useState(false);
  
  // Selection State
  const [selectedDate, setSelectedDate] = useState(() => {
    return new Date().toISOString().split('T')[0];
  });

  // Input State
  const [newTaskText, setNewTaskText] = useState("");
  const [ampm, setAmpm] = useState("오전");
  const [hour, setHour] = useState("9");
  const [minute, setMinute] = useState("00");
  const [loading, setLoading] = useState(true);

  // 1. Authentication & Fallback Logic
  const initAuth = async () => {
    try {
      setAuthError(null);
      setIsRetrying(true);
      await signInAnonymously(auth);
      // Success is handled by onAuthStateChanged
    } catch (error: any) {
      console.warn("Auth warning (falling back to offline):", error.message);
      
      let errorMessage = `로그인 오류: ${error.message}`;
      if (error.code === 'auth/configuration-not-found' || error.message.includes('configuration-not-found')) {
         errorMessage = "Firebase 콘솔 > Authentication > Sign-in method 에서 '익명(Anonymous)'을 사용 설정해주세요.";
      } else if (error.code === 'auth/api-key-not-valid') {
         errorMessage = "API Key가 올바르지 않습니다.";
      } else if (error.code === 'auth/operation-not-allowed') {
         errorMessage = "익명 로그인이 비활성화되어 있습니다. Firebase 콘솔을 확인하세요.";
      }
      
      setAuthError(errorMessage);
      setIsOfflineMode(true);
      setLoading(false);
    } finally {
      setIsRetrying(false);
    }
  };

  useEffect(() => {
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      if (currentUser) {
        setAuthError(null);
        setIsOfflineMode(false);
      }
      if (!currentUser && !isOfflineMode) setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // 2. Data Sync (Firestore or LocalStorage)
  useEffect(() => {
    // Mode 1: Firebase Online
    if (user && !isOfflineMode) {
      const tasksCollectionRef = collection(db, 'artifacts', appId, 'users', user.uid, 'tasks');
      const q = query(tasksCollectionRef);

      const unsubscribe = onSnapshot(q, (snapshot) => {
        const fetchedTasks = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        })) as Task[];
        setTasks(fetchedTasks);
        setLoading(false);
      }, (error) => {
        console.warn("Firestore access failed (falling back to offline):", error);
        setIsOfflineMode(true);
        setLoading(false);
      });
      return () => unsubscribe();
    }
    
    // Mode 2: Offline / LocalStorage Fallback
    if (isOfflineMode) {
      const localTasks = localStorage.getItem('offline_tasks');
      if (localTasks) {
        setTasks(JSON.parse(localTasks));
      }
      setLoading(false);
    }
  }, [user, isOfflineMode]);

  // Helper to save to local storage
  const saveLocal = (newTasks: Task[]) => {
    setTasks(newTasks);
    localStorage.setItem('offline_tasks', JSON.stringify(newTasks));
  };

  // --- Handlers ---

  const changeDate = (offset: number) => {
    const date = new Date(selectedDate);
    date.setDate(date.getDate() + offset);
    setSelectedDate(date.toISOString().split('T')[0]);
  };

  const addTask = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!newTaskText.trim()) return;

    let hourInt = parseInt(hour);
    if (ampm === "오후" && hourInt !== 12) hourInt += 12;
    if (ampm === "오전" && hourInt === 12) hourInt = 0;
    const timeToSave = `${hourInt.toString().padStart(2, '0')}:${minute}`;

    const newTask: any = {
      text: newTaskText,
      date: selectedDate,
      time: timeToSave,
      completed: false,
      createdAt: new Date().toISOString() // Use string for local compatibility
    };

    if (isOfflineMode) {
      // Offline Add
      const taskWithId = { ...newTask, id: crypto.randomUUID() };
      saveLocal([...tasks, taskWithId]);
      setNewTaskText("");
    } else if (user) {
      // Firebase Add
      try {
        const tasksCollectionRef = collection(db, 'artifacts', appId, 'users', user.uid, 'tasks');
        await addDoc(tasksCollectionRef, {
          ...newTask,
          createdAt: serverTimestamp()
        });
        setNewTaskText("");
      } catch (error) {
        console.error("Error adding task:", error);
        alert("저장 실패. 오프라인 모드로 전환합니다.");
        setIsOfflineMode(true);
      }
    }
  };

  const toggleTask = async (task: Task) => {
    if (isOfflineMode) {
      const updated = tasks.map(t => t.id === task.id ? { ...t, completed: !t.completed } : t);
      saveLocal(updated);
    } else if (user) {
      try {
        const taskDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'tasks', task.id);
        await updateDoc(taskDocRef, { completed: !task.completed });
      } catch (error) {
        console.error("Error toggling task:", error);
      }
    }
  };

  const deleteTask = async (taskId: string) => {
    if (isOfflineMode) {
      const updated = tasks.filter(t => t.id !== taskId);
      saveLocal(updated);
    } else if (user) {
      try {
        const taskDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'tasks', taskId);
        await deleteDoc(taskDocRef);
      } catch (error) {
        console.error("Error deleting task:", error);
      }
    }
  };

  const formatTime12 = (time24: string) => {
    if (!time24) return "";
    const [h, m] = time24.split(':').map(Number);
    const period = h >= 12 ? '오후' : '오전';
    const h12 = h % 12 || 12;
    return `${period} ${h12}:${m.toString().padStart(2, '0')}`;
  };

  // --- Sorting ---
  const filteredTasks = tasks.filter(t => 
    t.date === selectedDate || (!t.date && !t.createdAt) 
  ).sort((a, b) => {
    if (a.time === b.time) return 0;
    return a.time > b.time ? 1 : -1;
  });

  const completedCount = filteredTasks.filter(t => t.completed).length;
  const progress = filteredTasks.length > 0 ? (completedCount / filteredTasks.length) * 100 : 0;
  
  const formattedDate = new Date(selectedDate).toLocaleDateString('ko-KR', {
    year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
  });
  const hours = Array.from({ length: 12 }, (_, i) => (i + 1).toString());
  const minutes = Array.from({ length: 12 }, (_, i) => (i * 5).toString().padStart(2, '0'));

  return (
    <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4 font-sans text-slate-800">
      <div className="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col h-[85vh]">
        
        {/* Error / Offline Banner */}
        {isOfflineMode && (
          <div className="bg-orange-50 p-3 border-b border-orange-100 flex flex-col gap-2 shrink-0">
            <div className="flex items-start gap-3">
              <WifiOff className="w-5 h-5 text-orange-500 shrink-0 mt-0.5" />
              <div className="flex-1">
                <h3 className="text-sm font-bold text-orange-800 flex items-center gap-2">
                  오프라인 모드
                  <span className="text-[10px] bg-orange-200 text-orange-800 px-1.5 py-0.5 rounded-full font-normal">데이터 로컬 저장</span>
                </h3>
                <p className="text-xs text-orange-700 mt-1 leading-snug">
                  {authError || "네트워크 또는 설정 문제로 오프라인 모드에서 실행됩니다."}
                </p>
              </div>
            </div>
            {authError && (
              <button 
                onClick={initAuth}
                disabled={isRetrying}
                className="self-end flex items-center gap-1.5 px-3 py-1.5 bg-orange-100 hover:bg-orange-200 text-orange-800 text-xs rounded-lg transition-colors font-medium"
              >
                <RefreshCw className={`w-3.5 h-3.5 ${isRetrying ? 'animate-spin' : ''}`} />
                {isRetrying ? '연결 시도 중...' : '설정 후 다시 연결'}
              </button>
            )}
          </div>
        )}

        {/* Header Section */}
        <div className={`p-6 pb-6 text-white shrink-0 shadow-md z-10 transition-colors ${isOfflineMode ? 'bg-slate-600' : 'bg-indigo-600'}`}>
          <div className="flex items-center justify-between mb-6">
            <h1 className="text-xl font-bold flex items-center gap-2">
              <Calendar className="w-6 h-6" />
              하루 일과 {isOfflineMode && <span className="text-xs font-normal opacity-70 bg-black/20 px-2 py-0.5 rounded-full">Offline</span>}
            </h1>
            <input 
              type="date" 
              value={selectedDate}
              onChange={(e) => setSelectedDate(e.target.value)}
              className={`bg-white/20 text-white border border-white/30 rounded-lg px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-white/50`}
            />
          </div>

          <div className="flex items-center justify-between gap-4 mb-4">
            <button onClick={() => changeDate(-1)} className="p-2 hover:bg-white/20 rounded-full">
              <ChevronLeft className="w-6 h-6" />
            </button>
            <h2 className="text-lg font-bold leading-tight">{formattedDate}</h2>
            <button onClick={() => changeDate(1)} className="p-2 hover:bg-white/20 rounded-full">
              <ChevronRight className="w-6 h-6" />
            </button>
          </div>
          
          <div className="flex justify-between text-xs text-white/80 mb-1 px-1">
            <span>오늘의 달성률</span>
            <span>{Math.round(progress)}% ({completedCount}/{filteredTasks.length})</span>
          </div>
          <div className="bg-black/20 rounded-full h-2 w-full">
            <div 
              className="bg-green-400 h-2 rounded-full transition-all duration-500 ease-out shadow-[0_0_10px_rgba(74,222,128,0.5)]"
              style={{ width: `${progress}%` }}
            />
          </div>
        </div>

        {/* Task List Section */}
        <div className="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50">
          {loading ? (
            <div className="flex justify-center items-center h-full text-gray-400">
              <p>로딩 중...</p>
            </div>
          ) : filteredTasks.length === 0 ? (
            <div className="flex flex-col items-center justify-center h-full text-gray-400 space-y-3">
              <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-sm">
                <Calendar className="w-8 h-8 text-gray-300" />
              </div>
              <p className="text-sm text-center text-gray-500">
                일정이 없습니다.<br/>새로운 계획을 세워보세요!
              </p>
            </div>
          ) : (
            filteredTasks.map((task) => (
              <div 
                key={task.id} 
                className={`group flex items-center gap-3 p-3.5 bg-white rounded-xl shadow-sm border border-gray-100 transition-all hover:shadow-md ${task.completed ? 'bg-gray-50/80' : ''}`}
              >
                <button 
                  onClick={() => toggleTask(task)}
                  className={`shrink-0 transition-all duration-200 ${task.completed ? 'text-green-500 scale-110' : 'text-gray-300 hover:text-indigo-500 hover:scale-110'}`}
                >
                  {task.completed ? <CheckCircle2 className="w-6 h-6" /> : <Circle className="w-6 h-6" />}
                </button>
                
                <div className="flex-1 min-w-0">
                  <div className={`text-sm font-medium break-words ${task.completed ? 'text-gray-400 line-through' : 'text-gray-800'}`}>
                    {task.text}
                  </div>
                  <div className="flex items-center text-xs text-gray-500 mt-1 font-medium">
                    <Clock className="w-3 h-3 mr-1 text-indigo-400" />
                    {formatTime12(task.time)}
                  </div>
                </div>

                <button 
                  onClick={() => deleteTask(task.id)}
                  className="shrink-0 p-2 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-lg opacity-0 group-hover:opacity-100 focus:opacity-100"
                >
                  <Trash2 className="w-4 h-4" />
                </button>
              </div>
            ))
          )}
        </div>

        {/* Input Section */}
        <div className="p-4 bg-white border-t border-gray-100 shrink-0 shadow-lg z-20">
          <form onSubmit={addTask} className="flex flex-col gap-2">
            <div className="text-xs text-gray-400 mb-1 px-1 flex justify-between">
              <span>새 일정 추가 ({formattedDate})</span>
            </div>
            <div className="flex gap-2">
              <div className="flex gap-1 shrink-0">
                <select value={ampm} onChange={(e) => setAmpm(e.target.value)} className="bg-gray-50 border border-gray-200 rounded-lg px-2 py-2 text-sm">
                  <option value="오전">오전</option>
                  <option value="오후">오후</option>
                </select>
                <div className="flex items-center gap-1 bg-gray-50 border border-gray-200 rounded-lg px-2">
                  <select value={hour} onChange={(e) => setHour(e.target.value)} className="bg-transparent text-sm py-2 text-center w-10 appearance-none">
                    {hours.map(h => <option key={h} value={h}>{h}</option>)}
                  </select>
                  <span className="text-gray-400">:</span>
                  <select value={minute} onChange={(e) => setMinute(e.target.value)} className="bg-transparent text-sm py-2 text-center w-10 appearance-none">
                    {minutes.map(m => <option key={m} value={m}>{m}</option>)}
                  </select>
                </div>
              </div>
              <input
                type="text"
                value={newTaskText}
                onChange={(e) => setNewTaskText(e.target.value)}
                placeholder="할 일 입력..."
                className="flex-1 px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
              />
              <button
                type="submit"
                disabled={!newTaskText.trim()}
                className={`${isOfflineMode ? 'bg-slate-600 hover:bg-slate-700' : 'bg-indigo-600 hover:bg-indigo-700'} text-white px-3 rounded-xl shadow-lg flex items-center justify-center`}
              >
                <Plus className="w-5 h-5" />
              </button>
            </div>
          </form>
        </div>

      </div>
    </div>
  );
}